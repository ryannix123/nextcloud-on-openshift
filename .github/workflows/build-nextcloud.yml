# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Nextcloud Container Build Pipeline
# Builds with Podman and pushes to Quay.io
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Required GitHub Secrets:
#   QUAY_USERNAME - Quay.io robot account (format: username+robotname)
#   QUAY_PASSWORD - Quay.io robot token
#
# Usage:
#   - Manual: Actions â†’ Build and Push Nextcloud â†’ Run workflow
#   - Scheduled: Runs automatically every Monday at 6am UTC
#   - On push: Builds when Containerfile or configs change on main branch
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Build and Push Nextcloud

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      nextcloud_version:
        description: 'Nextcloud version to build (leave empty for latest)'
        required: false
        default: ''

  # Auto-run weekly to pick up new releases
  schedule:
  - cron: '0 6 * * 1' # Every Monday at 6am UTC
  # Build on push to main when container-related files change
  push:
    branches: [ main ]
    paths:
    - 'nextcloud-simple-custom/Containerfile'
    - 'nextcloud-simple-custom/nginx.conf'
    - 'nextcloud-simple-custom/supervisord.conf'
    - 'nextcloud-simple-custom/entrypoint.sh'
    - '.github/workflows/build-nextcloud.yml'

env:
  REGISTRY: quay.io
  IMAGE_NAME: ryan_nix/nextcloud-openshift
  BUILD_CONTEXT: ./nextcloud-simple-custom

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Determine which Nextcloud version to build
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Determine Nextcloud version
      id: version
      run: |
        # Use manual input if provided
        if [ -n "${{ inputs.nextcloud_version }}" ]; then
          VERSION="${{ inputs.nextcloud_version }}"
          echo "Using manually specified version: ${VERSION}"
        else
          # Fetch latest stable version from Nextcloud releases
          echo "Fetching latest Nextcloud version..."
          VERSION=$(curl -sL https://download.nextcloud.com/server/releases/ | \
                    grep -oP 'nextcloud-\K[0-9]+\.[0-9]+\.[0-9]+(?=\.tar\.bz2")' | \
                    sort -V | tail -1)
          
          if [ -z "${VERSION}" ]; then
            echo "::error::Failed to determine latest Nextcloud version"
            exit 1
          fi
          echo "Latest stable version: ${VERSION}"
        fi

        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "### ðŸ·ï¸ Building Nextcloud ${VERSION}" >> $GITHUB_STEP_SUMMARY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Check if this version already exists in registry (skip if so)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check if image already exists
      id: check
      run: |
        # Try to pull the manifest without downloading the image
        if podman manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} > /dev/null 2>&1; then
          echo "Image tag ${{ steps.version.outputs.version }} already exists"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Image tag ${{ steps.version.outputs.version }} not found, will build"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Build the container image
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build with Podman
      if: steps.check.outputs.exists == 'false' || github.event_name == 'workflow_dispatch'
      working-directory: ./nextcloud-simple-custom
      run: |
        echo "Building Nextcloud ${{ steps.version.outputs.version }}..."

        podman build \
          --build-arg NEXTCLOUD_VERSION=${{ steps.version.outputs.version }} \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -f Containerfile \
          .

        echo "### âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Image: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Push to Quay.io
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Log in to Quay.io
      if: steps.check.outputs.exists == 'false' || github.event_name == 'workflow_dispatch'
      run: |
        podman login \
          --username ${{ secrets.QUAY_USERNAME }} \
          --password ${{ secrets.QUAY_PASSWORD }} \
          ${{ env.REGISTRY }}

    - name: Push to Quay.io
      if: steps.check.outputs.exists == 'false' || github.event_name == 'workflow_dispatch'
      run: |
        echo "Pushing images to Quay.io..."

        podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
        podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

        echo "### ðŸš€ Push completed" >> $GITHUB_STEP_SUMMARY
        echo "- Version tag: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Latest tag: \`latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- Registry: [quay.io/${{ env.IMAGE_NAME }}](https://${{ env.REGISTRY }}/repository/${{ env.IMAGE_NAME }})" >> $GITHUB_STEP_SUMMARY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Summary for skipped builds
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Skip summary
      if: steps.check.outputs.exists == 'true' && github.event_name != 'workflow_dispatch'
      run: |
        echo "### â­ï¸ Build skipped" >> $GITHUB_STEP_SUMMARY
        echo "Image \`${{ steps.version.outputs.version }}\` already exists in registry." >> $GITHUB_STEP_SUMMARY
        echo "Use manual workflow dispatch to force a rebuild." >> $GITHUB_STEP_SUMMARY
