# Nextcloud Helm Chart - OpenShift Restricted SCC Values
# 
# This values file configures the Nextcloud Helm chart to run under
# OpenShift's restricted SCC without requiring any elevated privileges.
#
# Usage:
#   helm install nextcloud nextcloud/nextcloud \
#     -f openshift-values.yaml \
#     --set nextcloud.host=nextcloud.apps.mycluster.example.com \
#     --set nextcloud.password=YourSecurePassword \
#     -n nextcloud
#
# Post-install configuration required:
#   oc exec deploy/nextcloud -c nextcloud -- php occ config:system:set trusted_domains 2 --value="YOUR_HOSTNAME"
#   oc exec deploy/nextcloud -c nextcloud -- php occ config:system:set check_data_directory_permissions --value="false" --type=boolean

image:
  repository: nextcloud
  flavor: fpm-alpine
  pullPolicy: IfNotPresent

nextcloud:
  host: nextcloud.apps.example.com  # CHANGE THIS
  username: admin
  # password: set via --set or existingSecret
  containerPort: 9000

  podSecurityContext:
    # Do NOT set runAsUser or fsGroup - OpenShift assigns from namespace range
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault

  extraEnv:
    - name: TRUSTED_PROXIES
      value: "10.0.0.0/8 172.16.0.0/12 192.168.0.0/16"
    - name: OVERWRITEPROTOCOL
      value: "https"

  configs:
    proxy.config.php: |-
      <?php
      $CONFIG = array (
        'trusted_proxies' => ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'],
        'overwriteprotocol' => 'https',
      );

nginx:
  enabled: true
  image:
    # CRITICAL: Use nginx-unprivileged for rootless operation
    repository: nginxinc/nginx-unprivileged
    tag: alpine
  
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault
  
  containerPort: 8080

  config:
    default: false
    # Server block only - included inside http{} by nginx-unprivileged base config
    # NOTE: No $uri/ in try_files to avoid 403 on directory paths
    custom: |-
      server {
          listen 8080;
          server_name _;
          root /var/www/html;
          index index.php index.html;
          
          client_max_body_size 10G;
          fastcgi_buffers 64 4K;
          
          location = /robots.txt {
              allow all;
              log_not_found off;
              access_log off;
          }
          
          location ^~ /.well-known {
              location = /.well-known/carddav { return 301 /remote.php/dav/; }
              location = /.well-known/caldav { return 301 /remote.php/dav/; }
              return 301 /index.php$request_uri;
          }
          
          location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; }
          location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) { return 404; }
          
          location ~ \.php(?:$|/) {
              rewrite ^/(?!index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+|.+\/richdocumentscode(_arm64)?\/proxy) /index.php$request_uri;
              
              fastcgi_split_path_info ^(.+?\.php)(/.*)$;
              set $path_info $fastcgi_path_info;
              try_files $fastcgi_script_name =404;
              
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $path_info;
              fastcgi_param HTTPS on;
              fastcgi_param modHeadersAvailable true;
              fastcgi_param front_controller_active true;
              fastcgi_pass 127.0.0.1:9000;
              
              fastcgi_intercept_errors on;
              fastcgi_request_buffering off;
              fastcgi_read_timeout 600;
          }
          
          location ~ \.(?:css|js|mjs|svg|gif|png|jpg|ico|wasm|tflite|map)$ {
              try_files $uri /index.php$request_uri;
              expires max;
              access_log off;
          }
          
          location ~ \.woff2?$ {
              try_files $uri /index.php$request_uri;
              expires 7d;
              access_log off;
          }
          
          location / {
              try_files $uri /index.php$request_uri;
          }
      }

# Database configuration
# For production, use external PostgreSQL
internalDatabase:
  enabled: false

externalDatabase:
  enabled: true
  type: postgresql
  host: nextcloud-postgresql
  port: 5432
  database: nextcloud
  user: nextcloud
  # password: set via --set or existingSecret

postgresql:
  enabled: true
  global:
    postgresql:
      auth:
        username: nextcloud
        database: nextcloud
        # password: set via --set
  
  primary:
    podSecurityContext:
      enabled: true
      # Do NOT set fsGroup
    
    containerSecurityContext:
      enabled: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault
    
    persistence:
      enabled: true
      size: 8Gi

mariadb:
  enabled: false

# Redis for caching
redis:
  enabled: true
  auth:
    enabled: true
    # password: set via --set
  
  master:
    podSecurityContext:
      enabled: true
    
    containerSecurityContext:
      enabled: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault

  replica:
    podSecurityContext:
      enabled: true
    
    containerSecurityContext:
      enabled: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault

# Persistence
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 50Gi
  
  nextcloudData:
    enabled: true
    accessMode: ReadWriteOnce
    size: 100Gi

# Service configuration
service:
  type: ClusterIP
  port: 8080
  targetPort: 8080

# Use OpenShift Route instead of Ingress
ingress:
  enabled: false

# Health probes
# NOTE: Helm chart may default these to port 9000 (PHP-FPM)
# You may need to patch the deployment after install to use port 8080
livenessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 6

readinessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 15
  timeoutSeconds: 10
  failureThreshold: 6

startupProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

# Resources - adjust for your workload
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# RBAC
rbac:
  enabled: true
  serviceaccount:
    create: true
    name: nextcloud-serviceaccount

# Cron job for background tasks
cronjob:
  enabled: true
  schedule: "*/5 * * * *"
  
  securityContext:
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault

# Disable HPA by default
hpa:
  enabled: false

# Metrics
metrics:
  enabled: false
