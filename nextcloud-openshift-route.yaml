---
# OpenShift Route for Nextcloud
# Apply with: oc apply -f nextcloud-openshift-route.yaml
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    app.kubernetes.io/component: app
  annotations:
    # Large file upload support
    haproxy.router.openshift.io/timeout: 600s
    # Disable HAProxy buffering for large uploads
    haproxy.router.openshift.io/balance: "roundrobin"
spec:
  host: nextcloud.apps.example.com  # Change to your cluster's apps domain
  to:
    kind: Service
    name: nextcloud  # Matches the helm release service name
    weight: 100
  port:
    targetPort: 8080
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
  wildcardPolicy: None

---
# NetworkPolicy - Allow ingress from OpenShift router
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nextcloud-allow-router
  labels:
    app.kubernetes.io/name: nextcloud
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nextcloud
  policyTypes:
    - Ingress
  ingress:
    # Allow from OpenShift router namespace
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
      ports:
        - protocol: TCP
          port: 8080

---
# NetworkPolicy - Allow internal communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nextcloud-internal
  labels:
    app.kubernetes.io/name: nextcloud
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nextcloud
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from same namespace (for redis, postgres communication)
    - from:
        - podSelector: {}
  egress:
    # Allow to same namespace
    - to:
        - podSelector: {}
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow external HTTPS (for app store, updates, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80
